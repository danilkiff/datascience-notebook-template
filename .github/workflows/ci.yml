# SPDX-License-Identifier: Unlicense
name: CI

on:
  push:
    branches:
      - main
  pull_request:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    runs-on: ubuntu-24.04
    permissions:
      pull-requests: read
    outputs:
      docker: ${{ steps.filter.outputs.docker }}
      compose: ${{ steps.filter.outputs.compose }}
      markdown: ${{ steps.filter.outputs.markdown }}
      workflows: ${{ steps.filter.outputs.workflows }}
    steps:

      - name: Checkout
        uses: actions/checkout@v6

      - name: Detect changed paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            docker:
              - 'Dockerfile.*'
              - 'requirements/**'
            compose:
              - 'docker-compose*.yaml'
              - 'Dockerfile.*'
              - 'requirements/**'
              - '.env.example'
            markdown:
              - '**/*.md'
              - '.markdownlint.yaml'
            workflows:
              - '.github/workflows/**'

  compose-lint:
    needs: changes
    if: needs.changes.outputs.compose == 'true'
    runs-on: ubuntu-24.04
    steps:

      - name: Checkout
        uses: actions/checkout@v6

      - name: Validate docker-compose.yaml
        run: cp .env.example .env && docker compose config

      - name: Validate optional profiles
        run: >
          docker compose
          --profile monitoring
          --profile orchestration
          --profile serving
          config

  hadolint:
    needs: changes
    if: needs.changes.outputs.docker == 'true'
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        dockerfile:
          - Dockerfile.jupyter
          - Dockerfile.mlflow
          - Dockerfile.prefect
          - Dockerfile.serving
    steps:

      - name: Checkout
        uses: actions/checkout@v6

      - name: Hadolint ${{ matrix.dockerfile }}
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: ${{ matrix.dockerfile }}

  gitleaks:
    runs-on: ubuntu-24.04
    steps:

      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Gitleaks check
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  actionlint:
    needs: changes
    if: needs.changes.outputs.workflows == 'true'
    runs-on: ubuntu-24.04
    steps:

      - name: Checkout
        uses: actions/checkout@v6

      - name: Install actionlint
        run: bash <(curl -s https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash)

      - name: Actionlint check
        run: ./actionlint

  markdownlint:
    needs: changes
    if: needs.changes.outputs.markdown == 'true'
    runs-on: ubuntu-24.04
    steps:

      - name: Checkout
        uses: actions/checkout@v6

      - name: Markdown lint (install)
        run: npm i -g markdownlint-cli@0.47.0

      - name: Markdown lint (execute)
        run: markdownlint "**/*.md"

  smoke-test:
    needs: changes
    if: needs.changes.outputs.compose == 'true'
    runs-on: ubuntu-24.04
    steps:

      - name: Checkout
        uses: actions/checkout@v6

      - name: Prepare env
        run: cp .env.example .env

      - name: Build and start services
        run: docker compose up --detach --build

      - name: Wait for Jupyter
        run: |
          for i in $(seq 1 30); do
            if curl -sf http://localhost:8888/api > /dev/null 2>&1; then
              echo "Jupyter is ready"
              exit 0
            fi
            echo "Waiting for Jupyter... ($i/30)"
            sleep 5
          done
          echo "Jupyter failed to start"
          docker compose logs
          exit 1

      - name: Wait for MLflow
        run: |
          for i in $(seq 1 30); do
            if curl -sf http://localhost:5050/ > /dev/null 2>&1; then
              echo "MLflow is ready"
              exit 0
            fi
            echo "Waiting for MLflow... ($i/30)"
            sleep 5
          done
          echo "MLflow failed to start"
          docker compose logs
          exit 1

      - name: Dump logs on failure
        if: failure()
        run: docker compose logs

      - name: Cleanup
        if: always()
        run: docker compose down --volumes
